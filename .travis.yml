# This Source Code Form is licensed MPL-2.0: http://mozilla.org/MPL/2.0
#
# http://docs.travis-ci.com/user/customizing-the-build/
# http://lint.travis-ci.org/

os: linux
dist: trusty
sudo: required
services: docker
language: c

env:
  global:
    #- http_proxy="http://example.com"
    - bintray_url="https://dl.bintray.com/beast-team"
  matrix:
    # Distribution Name and Version
    - DN="debian" DV="jessie"
    - DN="debian" DV="testing"
    - DN="ubuntu" DV="trusty"
    - DN="ubuntu" DV="wily"
    - DN="ubuntu" DV="xenial"
matrix:
  allow_failures:
    - env: DN="debian" DV="testing"
    - env: DN="ubuntu" DV="xenial"
  fast_finish: true

before_install:
  - uname -a
  - cat /etc/os-release
  - pwd
  - free -tm
  - make --version
  - python --version
  - $CC --version

install:
  # Complete history is required for monotonic revisioning
  - travis_retry git fetch --unshallow
  # Point BINTRAYREPO at the beast-time package repository
  - export BINTRAYREPO="$bintray_url/$DN $DV main"
  # Configure Dockerfile by substituting @VAR@ with $VAR
  - ./buildtool.sh applyenv .travis.docker > Dockerfile
  # Build and run tests, create packages
  - docker build -t rapicorn .
  # Test package installation and removal locally
  - docker run -ti --rm rapicorn /bin/bash -c
        "set -x && dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz &&
        echo 'deb [trusted=yes] file:///usr/src ./' > /etc/apt/sources.list.d/usrsrc.list &&
        retry apt-get update && apt-get install -y rapicorn &&
        apt-get purge -y rapicorn && apt-get --purge -y autoremove"

script:
  # Upload packages
  - test -z "$DV" || docker run -ti --rm rapicorn /bin/bash -c \
        "export BINTRAY_APITOKEN=$BINTRAY_APITOKEN && ls -al && rapicorn/buildtool.sh bintrayup beast-team $DN/rapicorn $DV *.deb"
  # Test package installation from remote location
  - docker run -ti --rm rapicorn /bin/bash -c \
        "set -x && retry apt-get -y install apt-transport-https ca-certificates &&
        echo 'deb [trusted=yes] $BINTRAYREPO' | tee /etc/apt/sources.list.d/bintray-beast-team.list &&
        retry apt-get update && retry apt-get -y install rapicorn"
  - docker ps -a

after_success:
  - echo "Done, all OK!"

notifications:
  irc:
    channels:
      - "irc.gimp.org#beast"
    on_success: change # always / never / change
    on_failure: change # always / never / change
    skip_join: true
  email: false
    #recipients:
    #  - rapicorn@googlegroups.com
    #on_success: change
    #on_failure: change
