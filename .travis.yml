# This Source Code Form is licensed MPL-2.0: http://mozilla.org/MPL/2.0
#
# http://docs.travis-ci.com/user/customizing-the-build/
# http://lint.travis-ci.org/

os: linux
dist: trusty
sudo: required
services: docker
language: c
matrix:
  fast_finish: true

env:
  global:
    - http_proxy=""
  matrix:
    - DOCKERDIST="debian:jessie"  BINTRAYUP="jessie"
    - DOCKERDIST="ubuntu:wily",   BINTRAYUP="wily"
    - DOCKERDIST="ubuntu:trusty", BINTRAYUP=""

before_install:
  - uname -a
  - cat /etc/os-release
  - pwd
  - free -tm
  - make --version
  - python --version
  - $CC --version

install:
  # Complete history is required for VCSREVISION
  - travis_retry git fetch --unshallow
  # Configure Dockerfile
  - sed "s&@DOCKERDIST@&$DOCKERDIST&""g; ${http_proxy:+/^FROM\b/aENV http_proxy $http_proxy}" < .travis.docker > Dockerfile
  # Build and run tests, create packages
  - docker build -t rapicorn .

script:
  # Upload packages
  - test -z "$BINTRAYUP" || docker run -ti --rm rapicorn /bin/bash -c \
        "export BINTRAY_APITOKEN=$BINTRAY_APITOKEN && ls -al && rapicorn/buildtool.sh bintrayup beast-team $BINTRAYUP/rapicorn snapshot *.deb"
  - docker ps -a

after_success:
  - echo "Done, all OK!"

notifications:
  irc:
    channels:
      - "irc.gimp.org#beast"
    on_success: change # always / never / change
    on_failure: change # always / never / change
    skip_join: true
  email: false
    #recipients:
    #  - rapicorn@googlegroups.com
    #on_success: change
    #on_failure: change
